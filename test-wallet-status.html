<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayCio Wallet Status Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: monospace;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .warning { background: #fef3c7; color: #92400e; }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px;
        }
        button:hover { background: #5855eb; }
        .log {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç PayCio Wallet Status Test</h1>
        <p>This page helps debug wallet status and unlock issues.</p>
        
        <div>
            <button onclick="checkWalletStatus()">Check Wallet Status</button>
            <button onclick="checkStorage()">Check Storage</button>
            <button onclick="testUnlock()">Test Unlock</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div id="status-results"></div>
        
        <h3>Console Logs</h3>
        <div id="logs" class="log"></div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logsDiv = document.getElementById('logs');
            logsDiv.textContent = logs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function addStatus(message, type = 'info') {
            const container = document.getElementById('status-results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = '';
            document.getElementById('status-results').innerHTML = '';
        }

        async function checkWalletStatus() {
            log('Checking wallet status...');
            
            try {
                // Check if provider exists
                if (!window.ethereum) {
                    addStatus('‚ùå No Ethereum provider detected', 'error');
                    return;
                }
                
                addStatus('‚úÖ Ethereum provider detected', 'success');
                
                // Check if it's PayCio
                if (window.ethereum.isPayCio) {
                    addStatus('‚úÖ PayCio provider confirmed', 'success');
                } else {
                    addStatus('‚ö†Ô∏è Provider is not PayCio', 'warning');
                }
                
                // Check accounts
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        addStatus(`‚úÖ ${accounts.length} account(s) connected`, 'success');
                        addStatus(`  Primary: ${accounts[0]}`, 'info');
                    } else {
                        addStatus('‚ö†Ô∏è No accounts connected', 'warning');
                    }
                } catch (error) {
                    addStatus(`‚ùå Error getting accounts: ${error.message}`, 'error');
                }
                
                // Check chain ID
                try {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    addStatus(`‚úÖ Chain ID: ${chainId} (${parseInt(chainId, 16)})`, 'success');
                } catch (error) {
                    addStatus(`‚ùå Error getting chain ID: ${error.message}`, 'error');
                }
                
            } catch (error) {
                addStatus(`‚ùå Error: ${error.message}`, 'error');
                log(`Error: ${error.message}`);
            }
        }

        async function checkStorage() {
            log('Checking storage...');
            
            try {
                // Send message to background script to check storage
                const response = await new Promise((resolve, reject) => {
                    const messageId = Date.now().toString();
                    
                    const messageHandler = (event) => {
                        if (event.source !== window) return;
                        
                        if (event.data.type === 'STORAGE_CHECK_RESPONSE' && event.data.id === messageId) {
                            window.removeEventListener('message', messageHandler);
                            resolve(event.data);
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                    
                    // Send request to content script
                    window.postMessage({
                        type: 'STORAGE_CHECK_REQUEST',
                        id: messageId
                    }, '*');
                    
                    setTimeout(() => {
                        window.removeEventListener('message', messageHandler);
                        reject(new Error('Storage check timeout'));
                    }, 5000);
                });
                
                if (response.success) {
                    addStatus('‚úÖ Storage check successful', 'success');
                    addStatus(`  Wallet: ${response.wallet ? 'Found' : 'Not found'}`, 'info');
                    addStatus(`  Wallet State: ${response.walletState ? 'Found' : 'Not found'}`, 'info');
                    addStatus(`  Network: ${response.network ? 'Found' : 'Not found'}`, 'info');
                    addStatus(`  Is Unlocked: ${response.walletState?.isWalletUnlocked || false}`, 'info');
                } else {
                    addStatus(`‚ùå Storage check failed: ${response.error}`, 'error');
                }
                
            } catch (error) {
                addStatus(`‚ùå Storage check error: ${error.message}`, 'error');
                log(`Storage check error: ${error.message}`);
            }
        }

        async function testUnlock() {
            log('Testing unlock...');
            
            try {
                // Try to request accounts (this should trigger unlock if needed)
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length > 0) {
                    addStatus('‚úÖ Unlock successful', 'success');
                    addStatus(`  Accounts: ${accounts.length}`, 'info');
                } else {
                    addStatus('‚ö†Ô∏è No accounts after unlock', 'warning');
                }
                
            } catch (error) {
                addStatus(`‚ùå Unlock failed: ${error.message}`, 'error');
                log(`Unlock error: ${error.message}`);
            }
        }

        // Initialize
        log('PayCio Wallet Status Test Page Loaded');
        
        // Auto-check on load
        setTimeout(() => {
            checkWalletStatus();
        }, 1000);
    </script>
</body>
</html>
