<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayCio Wallet Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .wallet-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó PayCio Wallet Connection Test</h1>
        <p>This page tests if your PayCio Wallet extension is properly injected and accessible to dApps.</p>
        
        <div id="status"></div>
        
        <div class="test-section">
            <h3>üîç Basic Detection Tests</h3>
            <button onclick="testBasicDetection()">Test Basic Detection</button>
            <button onclick="testProviderInjection()">Test Provider Injection</button>
            <button onclick="testEIP6963()">Test EIP-6963</button>
        </div>
        
        <div class="test-section">
            <h3>üí∞ Wallet Connection Tests</h3>
            <button onclick="testEthAccounts()">Test eth_accounts</button>
            <button onclick="testEthRequestAccounts()">Test eth_requestAccounts</button>
            <button onclick="testEthChainId()">Test eth_chainId</button>
            <button onclick="testEthGetBalance()">Test eth_getBalance</button>
        </div>
        
        <div class="test-section">
            <h3>üîß Advanced Tests</h3>
            <button onclick="testWeb3Detection()">Test Web3 Detection</button>
            <button onclick="testEventListeners()">Test Event Listeners</button>
            <button onclick="testAllMethods()">Test All Methods</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="results"></div>
        </div>
        
        <div class="test-section">
            <h3>üìù Console Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const logDiv = document.getElementById('log');
        let testResults = {};
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            statusDiv.appendChild(div);
            log(message, type);
        }
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        function updateResults(testName, result) {
            testResults[testName] = result;
            displayResults();
        }
        
        function displayResults() {
            let html = '<div class="wallet-info">';
            html += '<h4>Test Summary:</h4>';
            
            const passed = Object.values(testResults).filter(r => r === true).length;
            const total = Object.keys(testResults).length;
            
            html += `<p><strong>Passed:</strong> ${passed}/${total}</p>`;
            
            for (const [test, result] of Object.entries(testResults)) {
                const status = result ? '‚úÖ' : '‚ùå';
                html += `<p>${status} ${test}</p>`;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        // Basic Detection Tests
        function testBasicDetection() {
            log('=== Testing Basic Detection ===');
            
            // Test 1: Check if content script is running
            const contentScriptRunning = window.paycioWalletContentScript?.isRunning;
            log(`Content script running: ${contentScriptRunning}`);
            updateResults('Content Script Running', contentScriptRunning);
            
            // Test 2: Check if ethereum provider exists
            const ethereumExists = !!window.ethereum;
            log(`Ethereum provider exists: ${ethereumExists}`);
            updateResults('Ethereum Provider Exists', ethereumExists);
            
            // Test 3: Check if it's PayCio Wallet
            const isPayCioWallet = window.ethereum?.isPayCioWallet;
            log(`isPayCioWallet: ${isPayCioWallet}`);
            updateResults('Is PayCio Wallet', isPayCioWallet);
            
            // Test 4: Check if paycioWallet exists
            const paycioWalletExists = !!window.paycioWallet;
            log(`paycioWallet exists: ${paycioWalletExists}`);
            updateResults('PayCio Wallet Direct Access', paycioWalletExists);
            
            if (isPayCioWallet) {
                addStatus('‚úÖ PayCio Wallet detected successfully!', 'success');
            } else {
                addStatus('‚ùå PayCio Wallet not detected', 'error');
            }
        }
        
        function testProviderInjection() {
            log('=== Testing Provider Injection ===');
            
            if (!window.ethereum) {
                log('‚ùå No ethereum provider found');
                updateResults('Provider Injection', false);
                addStatus('‚ùå No ethereum provider found', 'error');
                return;
            }
            
            // Test provider properties
            const provider = window.ethereum;
            const tests = [
                { name: 'has request method', test: typeof provider.request === 'function' },
                { name: 'has send method', test: typeof provider.send === 'function' },
                { name: 'has sendAsync method', test: typeof provider.sendAsync === 'function' },
                { name: 'has enable method', test: typeof provider.enable === 'function' },
                { name: 'has on method', test: typeof provider.on === 'function' },
                { name: 'has removeListener method', test: typeof provider.removeListener === 'function' }
            ];
            
            let passed = 0;
            tests.forEach(({ name, test }) => {
                log(`${test ? '‚úÖ' : '‚ùå'} ${name}: ${test}`);
                if (test) passed++;
            });
            
            const success = passed === tests.length;
            updateResults('Provider Methods', success);
            
            if (success) {
                addStatus('‚úÖ Provider injection test passed', 'success');
            } else {
                addStatus(`‚ö†Ô∏è Provider injection test partially passed (${passed}/${tests.length})`, 'warning');
            }
        }
        
        function testEIP6963() {
            log('=== Testing EIP-6963 Support ===');
            
            let providersFound = [];
            
            // Listen for EIP-6963 announcements
            const listener = (event) => {
                if (event.detail && event.detail.info && event.detail.provider) {
                    providersFound.push(event.detail.info.name);
                    log(`‚úÖ EIP-6963 provider found: ${event.detail.info.name}`);
                }
            };
            
            window.addEventListener('eip6963:announceProvider', listener);
            
            // Request providers
            window.dispatchEvent(new CustomEvent('eip6963:requestProvider'));
            
            // Check after a short delay
            setTimeout(() => {
                window.removeEventListener('eip6963:announceProvider', listener);
                
                const hasPayCioWallet = providersFound.some(name => name.includes('PayCio'));
                log(`EIP-6963 providers found: ${providersFound.join(', ')}`);
                updateResults('EIP-6963 Support', hasPayCioWallet);
                
                if (hasPayCioWallet) {
                    addStatus('‚úÖ EIP-6963 support working', 'success');
                } else {
                    addStatus('‚ö†Ô∏è EIP-6963 support not detected', 'warning');
                }
            }, 1000);
        }
        
        // Wallet Connection Tests
        async function testEthAccounts() {
            log('=== Testing eth_accounts ===');
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                log(`‚úÖ eth_accounts result: ${JSON.stringify(accounts)}`);
                updateResults('eth_accounts', true);
                addStatus('‚úÖ eth_accounts working', 'success');
            } catch (error) {
                log(`‚ùå eth_accounts failed: ${error.message}`);
                updateResults('eth_accounts', false);
                addStatus('‚ùå eth_accounts failed', 'error');
            }
        }
        
        async function testEthRequestAccounts() {
            log('=== Testing eth_requestAccounts ===');
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`‚úÖ eth_requestAccounts result: ${JSON.stringify(accounts)}`);
                updateResults('eth_requestAccounts', true);
                addStatus('‚úÖ eth_requestAccounts working', 'success');
            } catch (error) {
                log(`‚ùå eth_requestAccounts failed: ${error.message}`);
                updateResults('eth_requestAccounts', false);
                addStatus('‚ùå eth_requestAccounts failed', 'error');
            }
        }
        
        async function testEthChainId() {
            log('=== Testing eth_chainId ===');
            
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`‚úÖ eth_chainId result: ${chainId}`);
                updateResults('eth_chainId', true);
                addStatus('‚úÖ eth_chainId working', 'success');
            } catch (error) {
                log(`‚ùå eth_chainId failed: ${error.message}`);
                updateResults('eth_chainId', false);
                addStatus('‚ùå eth_chainId failed', 'error');
            }
        }
        
        async function testEthGetBalance() {
            log('=== Testing eth_getBalance ===');
            
            try {
                // First get accounts
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    log('‚ö†Ô∏è No accounts available for balance test');
                    updateResults('eth_getBalance', false);
                    addStatus('‚ö†Ô∏è No accounts for balance test', 'warning');
                    return;
                }
                
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                log(`‚úÖ eth_getBalance result: ${balance}`);
                updateResults('eth_getBalance', true);
                addStatus('‚úÖ eth_getBalance working', 'success');
            } catch (error) {
                log(`‚ùå eth_getBalance failed: ${error.message}`);
                updateResults('eth_getBalance', false);
                addStatus('‚ùå eth_getBalance failed', 'error');
            }
        }
        
        // Advanced Tests
        function testWeb3Detection() {
            log('=== Testing Web3 Detection ===');
            
            const hasWeb3 = typeof window.web3 !== 'undefined';
            log(`Web3 detected: ${hasWeb3}`);
            
            if (hasWeb3) {
                const hasCurrentProvider = !!window.web3.currentProvider;
                log(`Web3 currentProvider: ${hasCurrentProvider}`);
                updateResults('Web3 Detection', hasCurrentProvider);
                
                if (hasCurrentProvider) {
                    addStatus('‚úÖ Web3 detection working', 'success');
                } else {
                    addStatus('‚ö†Ô∏è Web3 detected but no currentProvider', 'warning');
                }
            } else {
                updateResults('Web3 Detection', false);
                addStatus('‚ö†Ô∏è Web3 not detected', 'warning');
            }
        }
        
        function testEventListeners() {
            log('=== Testing Event Listeners ===');
            
            if (!window.ethereum) {
                log('‚ùå No ethereum provider for event listener test');
                updateResults('Event Listeners', false);
                return;
            }
            
            let eventsReceived = 0;
            
            // Test event listener registration
            try {
                window.ethereum.on('accountsChanged', (accounts) => {
                    log(`‚úÖ accountsChanged event received: ${JSON.stringify(accounts)}`);
                    eventsReceived++;
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    log(`‚úÖ chainChanged event received: ${chainId}`);
                    eventsReceived++;
                });
                
                log('‚úÖ Event listeners registered successfully');
                updateResults('Event Listeners', true);
                addStatus('‚úÖ Event listeners working', 'success');
            } catch (error) {
                log(`‚ùå Event listener test failed: ${error.message}`);
                updateResults('Event Listeners', false);
                addStatus('‚ùå Event listeners failed', 'error');
            }
        }
        
        async function testAllMethods() {
            log('=== Testing All Methods ===');
            
            const methods = [
                'eth_accounts',
                'eth_requestAccounts',
                'eth_chainId',
                'eth_getBalance',
                'wallet_switchEthereumChain'
            ];
            
            let passed = 0;
            
            for (const method of methods) {
                try {
                    if (method === 'eth_getBalance') {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                            await window.ethereum.request({
                                method: 'eth_getBalance',
                                params: [accounts[0], 'latest']
                            });
                        }
                    } else if (method === 'wallet_switchEthereumChain') {
                        // This might fail if chain is already added, which is expected
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x1' }]
                            });
                        } catch (error) {
                            // Expected error if already on Ethereum mainnet
                            log(`‚ö†Ô∏è ${method}: ${error.message} (expected)`);
                        }
                    } else {
                        await window.ethereum.request({ method });
                    }
                    log(`‚úÖ ${method}: passed`);
                    passed++;
                } catch (error) {
                    log(`‚ùå ${method}: ${error.message}`);
                }
            }
            
            const success = passed >= methods.length - 1; // Allow one failure for switchEthereumChain
            updateResults('All Methods', success);
            
            if (success) {
                addStatus(`‚úÖ All methods test passed (${passed}/${methods.length})`, 'success');
            } else {
                addStatus(`‚ö†Ô∏è All methods test partially passed (${passed}/${methods.length})`, 'warning');
            }
        }
        
        // Auto-test on page load
        window.addEventListener('load', () => {
            addStatus('Page loaded, starting tests...', 'info');
            setTimeout(() => {
                testBasicDetection();
                testProviderInjection();
                testEIP6963();
            }, 1000);
        });
        
        // Check for extension every 5 seconds
        setInterval(() => {
            if (!window.ethereum && !window.paycioWalletContentScript?.isRunning) {
                addStatus('‚ö†Ô∏è Extension not detected - make sure PayCio Wallet is installed and enabled', 'warning');
            }
        }, 5000);
    </script>
</body>
</html>
