<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayCio Wallet Test DApp</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .status {
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 500;
    }
    
    .status.disconnected {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
    }
    
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 2px solid #28a745;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #dc3545;
    }
    
    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .results {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .result-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .result-item.error {
      border-left-color: #dc3545;
    }
    
    .result-item.success {
      border-left-color: #28a745;
    }
    
    .result-time {
      color: #999;
      font-size: 12px;
      margin-bottom: 5px;
    }
    
    .result-content {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      color: #333;
      word-break: break-all;
    }
    
    .clear-btn {
      background: #6c757d;
      margin-top: 15px;
    }
    
    .info-box {
      background: #e7f3ff;
      border: 2px solid #2196F3;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }
    
    .info-box h3 {
      color: #1976D2;
      margin-bottom: 10px;
    }
    
    .info-box ul {
      color: #555;
      margin-left: 20px;
      line-height: 1.8;
    }
    
    .emoji {
      font-size: 24px;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="emoji">üß™</span> PayCio Wallet Test DApp</h1>
    <p class="subtitle">Test your wallet connection, transactions, and signing</p>
    
    <div id="status" class="status disconnected">
      <strong>Status:</strong> Not connected. Click "Connect Wallet" to begin.
    </div>
    
    <div class="button-grid">
      <button onclick="testConnect()">üîó Connect Wallet</button>
      <button onclick="testGetAccounts()" id="btn-accounts">üìã Get Accounts</button>
      <button onclick="testChainId()" id="btn-chain">‚õìÔ∏è Get Chain ID</button>
      <button onclick="testBalance()" id="btn-balance">üí∞ Get Balance</button>
      <button onclick="testSignMessage()" id="btn-sign">‚úçÔ∏è Sign Message</button>
      <button onclick="testSignTypedData()" id="btn-typed">üìù Sign Typed Data</button>
      <button onclick="testSendTransaction()" id="btn-tx">üí∏ Send Transaction</button>
      <button onclick="testSwitchChain()" id="btn-switch">üîÑ Switch Chain</button>
    </div>
    
    <h3 style="margin-bottom: 15px;">üìä Test Results</h3>
    <div class="results" id="results"></div>
    <button onclick="clearResults()" class="clear-btn">üóëÔ∏è Clear Results</button>
    
    <div class="info-box">
      <h3>‚ÑπÔ∏è Testing Instructions</h3>
      <ul>
        <li><strong>First time:</strong> Click "Connect Wallet" - should show unlock popup if locked</li>
        <li><strong>After unlock:</strong> Connection should complete automatically</li>
        <li><strong>Transactions:</strong> Will show confirmation popup with details</li>
        <li><strong>Signing:</strong> Will show signature request with message preview</li>
        <li><strong>All operations:</strong> Check browser console for detailed logs</li>
      </ul>
    </div>
  </div>

  <script>
    // Detect and use PayCio provider specifically
    function getPayCioProvider() {
      console.log('üîç Searching for PayCio provider...');
      
      // Priority 1: Direct PayCio provider
      if (window.paycioProvider) {
        console.log('‚úÖ Found window.paycioProvider');
        return window.paycioProvider;
      }
      
      // Priority 2: Check if main ethereum is PayCio
      if (window.ethereum?.isPayCio) {
        console.log('‚úÖ Found PayCio as window.ethereum');
        return window.ethereum;
      }
      
      // Priority 3: Check for multiple providers (EIP-6963)
      if (window.ethereum?.providers && Array.isArray(window.ethereum.providers)) {
        console.log('üîç Multiple providers found, searching...');
        const paycio = window.ethereum.providers.find(p => p.isPayCio === true);
        if (paycio) {
          console.log('‚úÖ Found PayCio in providers array');
          return paycio;
        }
      }
      
      // Priority 4: Check all window properties for PayCio
      for (const key in window) {
        if (window[key]?.isPayCio === true) {
          console.log(`‚úÖ Found PayCio at window.${key}`);
          return window[key];
        }
      }
      
      console.warn('‚ö†Ô∏è PayCio provider not found, falling back to window.ethereum');
      return window.ethereum;
    }
    
    // Wait for provider injection (give extensions time to load)
    let provider = null;
    setTimeout(() => {
      provider = getPayCioProvider();
      initializeApp();
    }, 500); // Wait 500ms for providers to inject
    
    let connectedAccount = null;
    
    function initializeApp() {
      // Log provider detection
      console.log('üîç Final provider check:', {
        provider: provider ? 'Found' : 'Not found',
        isPayCio: provider?.isPayCio,
        isMetaMask: provider?.isMetaMask,
        constructor: provider?.constructor?.name,
        keys: provider ? Object.keys(provider).filter(k => k.includes('Pay') || k.includes('pay')) : []
      });
      
      if (!provider) {
        updateStatus('‚ö†Ô∏è No provider found. Please install PayCio Wallet.', 'error');
        return;
      }
      
      if (!provider.isPayCio) {
        updateStatus('‚ö†Ô∏è PayCio not detected. Using: ' + (provider.isMetaMask ? 'MetaMask' : 'Unknown'), 'error');
        log('‚ö†Ô∏è Warning: Not using PayCio provider!', 'error', {
          isPayCio: provider.isPayCio,
          isMetaMask: provider.isMetaMask
        });
      } else {
        updateStatus('‚úÖ PayCio Wallet detected and ready!', 'connected');
        log('‚úÖ PayCio provider initialized', 'success');
      }
      
      setupEventListeners();
    }
    
    function updateStatus(message, type = 'disconnected') {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.innerHTML = `<strong>Status:</strong> ${message}`;
    }
    
    function log(message, type = 'info', data = null) {
      const results = document.getElementById('results');
      const item = document.createElement('div');
      item.className = `result-item ${type}`;
      
      const time = new Date().toLocaleTimeString();
      const content = data ? `${message}\n${JSON.stringify(data, null, 2)}` : message;
      
      item.innerHTML = `
        <div class="result-time">${time}</div>
        <div class="result-content">${content}</div>
      `;
      
      results.insertBefore(item, results.firstChild);
      console.log(`[${time}] ${message}`, data);
    }
    
    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }
    
    async function testConnect() {
      try {
        updateStatus('Connecting...', 'disconnected');
        log('üîó Connecting to PayCio Wallet...', 'info');
        
        if (!provider) {
          throw new Error('PayCio Wallet not detected! Please install the extension.');
        }
        
        log(`üì± Using provider: ${provider.isPayCio ? 'PayCio ‚úÖ' : 'Unknown'}`, 'info');
        
        const accounts = await provider.request({ 
          method: 'eth_requestAccounts' 
        });
        
        if (accounts && accounts.length > 0) {
          connectedAccount = accounts[0];
          updateStatus(`Connected: ${connectedAccount}`, 'connected');
          log('‚úÖ Connected successfully!', 'success', { accounts });
          enableButtons();
        }
      } catch (error) {
        updateStatus(`Error: ${error.message}`, 'error');
        log('‚ùå Connection failed', 'error', { error: error.message });
      }
    }
    
    async function testGetAccounts() {
      try {
        log('üìã Getting accounts...', 'info');
        const accounts = await provider.request({ 
          method: 'eth_accounts' 
        });
        log('‚úÖ Accounts retrieved', 'success', { accounts });
      } catch (error) {
        log('‚ùå Failed to get accounts', 'error', { error: error.message });
      }
    }
    
    async function testChainId() {
      try {
        log('‚õìÔ∏è Getting chain ID...', 'info');
        const chainId = await provider.request({ 
          method: 'eth_chainId' 
        });
        const decimal = parseInt(chainId, 16);
        log('‚úÖ Chain ID retrieved', 'success', { 
          chainId, 
          decimal,
          network: getNetworkName(chainId)
        });
      } catch (error) {
        log('‚ùå Failed to get chain ID', 'error', { error: error.message });
      }
    }
    
    async function testBalance() {
      try {
        if (!connectedAccount) {
          throw new Error('Please connect wallet first');
        }
        log('üí∞ Getting balance...', 'info');
        const balance = await provider.request({
          method: 'eth_getBalance',
          params: [connectedAccount, 'latest']
        });
        const ethBalance = parseInt(balance, 16) / 1e18;
        log('‚úÖ Balance retrieved', 'success', { 
          balance, 
          eth: ethBalance.toFixed(4) + ' ETH' 
        });
      } catch (error) {
        log('‚ùå Failed to get balance', 'error', { error: error.message });
      }
    }
    
    async function testSignMessage() {
      try {
        if (!connectedAccount) {
          throw new Error('Please connect wallet first');
        }
        
        const message = 'Hello from PayCio Test DApp! üéâ';
        log('‚úçÔ∏è Signing message...', 'info', { message });
        
        const hexMessage = '0x' + Array.from(message)
          .map(c => c.charCodeAt(0).toString(16).padStart(2, '0'))
          .join('');
        
        const signature = await provider.request({
          method: 'personal_sign',
          params: [hexMessage, connectedAccount]
        });
        
        log('‚úÖ Message signed!', 'success', { 
          message, 
          signature: signature.substring(0, 20) + '...' 
        });
      } catch (error) {
        log('‚ùå Signing failed', 'error', { error: error.message });
      }
    }
    
    async function testSignTypedData() {
      try {
        if (!connectedAccount) {
          throw new Error('Please connect wallet first');
        }
        
        log('üìù Signing typed data...', 'info');
        
        const typedData = {
          domain: {
            name: 'PayCio Test DApp',
            version: '1',
            chainId: 1,
          },
          types: {
            Person: [
              { name: 'name', type: 'string' },
              { name: 'wallet', type: 'address' }
            ]
          },
          message: {
            name: 'Test User',
            wallet: connectedAccount
          }
        };
        
        const signature = await provider.request({
          method: 'eth_signTypedData_v4',
          params: [connectedAccount, JSON.stringify(typedData)]
        });
        
        log('‚úÖ Typed data signed!', 'success', { 
          data: typedData.message,
          signature: signature.substring(0, 20) + '...'
        });
      } catch (error) {
        log('‚ùå Typed data signing failed', 'error', { error: error.message });
      }
    }
    
    async function testSendTransaction() {
      try {
        if (!connectedAccount) {
          throw new Error('Please connect wallet first');
        }
        
        log('üí∏ Sending transaction...', 'info');
        
        // Send 0.001 ETH to a test address
        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [{
            from: connectedAccount,
            to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0',
            value: '0x38d7ea4c68000', // 0.001 ETH
            gas: '0x5208', // 21000
          }]
        });
        
        log('‚úÖ Transaction sent!', 'success', { 
          txHash,
          explorer: `https://etherscan.io/tx/${txHash}`
        });
      } catch (error) {
        log('‚ùå Transaction failed', 'error', { error: error.message });
      }
    }
    
    async function testSwitchChain() {
      try {
        log('üîÑ Switching to Polygon...', 'info');
        
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x89' }] // Polygon
        });
        
        log('‚úÖ Chain switched!', 'success', { network: 'Polygon' });
      } catch (error) {
        log('‚ùå Chain switch failed', 'error', { error: error.message });
      }
    }
    
    function getNetworkName(chainId) {
      const networks = {
        '0x1': 'Ethereum Mainnet',
        '0x38': 'BSC',
        '0x89': 'Polygon',
        '0xa86a': 'Avalanche',
        '0xa4b1': 'Arbitrum',
        '0xa': 'Optimism'
      };
      return networks[chainId] || `Chain ${chainId}`;
    }
    
    function enableButtons() {
      const buttons = ['accounts', 'chain', 'balance', 'sign', 'typed', 'tx', 'switch'];
      buttons.forEach(btn => {
        document.getElementById(`btn-${btn}`).disabled = false;
      });
    }
    
    // Listen for events
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        log('üîÑ Accounts changed', 'info', { accounts });
        if (accounts.length > 0) {
          connectedAccount = accounts[0];
          updateStatus(`Connected: ${connectedAccount}`, 'connected');
        } else {
          connectedAccount = null;
          updateStatus('Disconnected', 'disconnected');
        }
      });
      
      provider.on('chainChanged', (chainId) => {
        log('üîÑ Chain changed', 'info', { chainId, network: getNetworkName(chainId) });
        window.location.reload();
      });
      
      provider.on('connect', (info) => {
        log('üîó Connected to network', 'success', info);
      });
      
      provider.on('disconnect', (error) => {
        log('‚ùå Disconnected', 'error', error);
        updateStatus('Disconnected', 'error');
      });
    } else {
      updateStatus('PayCio Wallet not detected! Please install the extension.', 'error');
      log('‚ùå PayCio Wallet not found', 'error', {
        message: 'Please install the PayCio Wallet extension'
      });
    }
    
    // Disable buttons until connected
    const buttons = ['accounts', 'chain', 'balance', 'sign', 'typed', 'tx', 'switch'];
    buttons.forEach(btn => {
      document.getElementById(`btn-${btn}`).disabled = true;
    });
  </script>
</body>
</html>
